#!/usr/bin/env bash

export TF_VAR_kexec_tarball="$(nix build .#kexec-installer-nixos-unstable-noninteractive --print-out-paths --no-link)/nixos-kexec-installer-noninteractive-x86_64-linux.tar.gz"

function destroy() {
  tofu destroy \
    -target=hcloud_server.dev \
    -target=random_string.host \
    -target=module.dev-system-build \
    -target=module.dev-disko \
    -target=module.dev-install \
    -auto-approve
}

if hcloud server list -l "tfstate=dev" -o json | jq -e '. | any | not'; then
  destroy
fi

tofu apply -auto-approve
sleep 5

unlocked_all=1
retries=5

function unlock() {
  retries=$((retries - 1))
  unlocked_all=1
  for server in $(hcloud server list -o noheader -l "tfstate=dev" | awk '{print $4}'); do
    echo "Probing host ${server} on strPort 2222"
    if timeout 5 bash -c "</dev/tcp/${server}/2222"; then
      echo "Host ${server} is up, unlocking"
      rbw get hetzner -- cloud_disk_password | ssh -oStrictHostKeyChecking=no -oUserKnownHostsFile=/dev/null -i /home/john/.ssh/id_ed25519_alt -p 2222 "root@${server}"
    else
      if timeout 5 bash -c "</dev/tcp/${server}/22"; then
        echo "Host ${server} is already unlocked"
      else
        unlocked_all=0
        echo "Host ${server} is down, retry later"
      fi
    fi
  done
}

function purge() {
  echo "purging and recreating server"
  destroy
  exec $0
}

unlock
while true; do
  if [[ ${unlocked_all} -eq 0 ]]; then
    if [ ${retries} -le 0 ]; then
      purge
    fi
    echo "retrying unlocking in 5 seconds"
    sleep 5
    unlock
  else
    echo "unlocked all, exiting"
    exit 0
  fi
done
